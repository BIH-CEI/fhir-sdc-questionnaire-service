version: '3.8'

services:
  # PostgreSQL database for HAPI FHIR
  db:
    image: postgres:15-alpine
    container_name: fhir-postgres
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - fhir-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # HAPI FHIR Server
  hapi-fhir:
    image: hapiproject/hapi:latest
    container_name: hapi-fhir-server
    env_file:
      - .env
    environment:
      # Load additional YAML config from mounted volume
      SPRING_CONFIG_ADDITIONAL_LOCATION: file:/data/hapi/

      # Clinical Reasoning Module - Enables $populate, $extract, CQL operations
      hapi.fhir.cr.enabled: true

      # Database configuration (uses env vars from .env)
      spring.datasource.url: jdbc:postgresql://db:5432/${POSTGRES_DB}
      spring.datasource.username: ${POSTGRES_USER}
      spring.datasource.password: ${POSTGRES_PASSWORD}
      spring.datasource.driverClassName: org.postgresql.Driver
      spring.jpa.properties.hibernate.dialect: ca.uhn.fhir.jpa.model.dialect.HapiFhirPostgres94Dialect

      # FHIR version
      hapi.fhir.fhir_version: ${FHIR_VERSION}

      # Enable terminology services
      hapi.fhir.enable_index_missing_fields: true
      hapi.fhir.auto_create_placeholder_reference_targets: true

      # Search configuration
      hapi.fhir.reuse_cached_search_results_millis: 60000
      hapi.fhir.default_page_size: ${HAPI_DEFAULT_PAGE_SIZE}
      hapi.fhir.max_page_size: ${HAPI_MAX_PAGE_SIZE}

      # CORS configuration (for frontend)
      hapi.fhir.cors.allowed_origin: ${HAPI_CORS_ALLOWED_ORIGIN}
      hapi.fhir.cors.allow_credentials: ${HAPI_CORS_ALLOW_CREDENTIALS}

      # Narrative generation
      hapi.fhir.narrative_enabled: true

      # Validation
      hapi.fhir.validation_enabled: true
      hapi.fhir.validation_server_url: http://hapi-fhir:8080/fhir

      # Clinical Reasoning / CQL - Enabled via application.yaml (hapi.fhir.cr.enabled: true)
      # Note: Environment var approach would be: hapi.fhir.cql_enabled: true (deprecated)
      # Using application.yaml for better configuration management
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - fhir-network
    # Healthcheck disabled - HAPI container doesn't have curl/wget
    # Services will wait via sleep delay instead
    volumes:
      - hapi_data:/data/hapi
      - ./hapi-config/application.yaml:/data/hapi/application.yaml:ro

  # ISiK Runtime Installer - Runs once after HAPI startup
  isik-installer:
    image: python:3.11-slim
    container_name: isik-installer
    depends_on:
      - hapi-fhir
    networks:
      - fhir-network
    volumes:
      - ./scripts:/scripts
    environment:
      HAPI_BASE_URL: http://hapi-fhir:8080/fhir
    command: >
      sh -c "pip install -q requests &&
             python3 /scripts/install-isik-runtime.py &&
             echo 'ISiK installation complete. Container will exit.' &&
             exit 0"
    restart: "no"

  # FastAPI custom business logic layer
  fastapi:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: form-manager-api
    env_file:
      - .env
    ports:
      - "8000:8000"
    depends_on:
      - hapi-fhir
    networks:
      - fhir-network
    volumes:
      - ./api:/app
    command: >
      sh -c "sleep 30 && uvicorn app.main:app --host ${API_HOST} --port ${API_PORT} --reload"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s

  # React frontend (optional, for later)
  # frontend:
  #   build:
  #     context: ./ui
  #     dockerfile: Dockerfile
  #   container_name: form-manager-ui
  #   ports:
  #     - "3000:3000"
  #   depends_on:
  #     - fastapi
  #   networks:
  #     - fhir-network
  #   volumes:
  #     - ./ui:/app
  #     - /app/node_modules

networks:
  fhir-network:
    driver: bridge

volumes:
  postgres_data:
  hapi_data:
